---
title: "R Notebook"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
  '': default
editor_options:
  markdown:
    wrap: 75
---

Course: Field Course Micrometeorology and Urban Climate at the University
of Bern (Institute of Geography)

Supervisor: Prof. Dr. Stefan Brönnimann

Adviser: Dr. Moritz Gubler

Do you have questions about the workflow? Contact the Authors:

Bigler Patrick
([patrick.bigler1\@students.unibe.ch](mailto:patrick.bigler1@students.unibe.ch){.email})

Sarah Ogi
([sarah.ogi\@students.unibe.ch](mailto:sarah.ogi@students.unibe.ch){.email})

Markella Bouchoriku
([markella.bouchoriku\@students.unibe.ch](mailto:markella.bouchoriku@students.unibe.ch){.email}
)

Reference: Zollikofen

# Introduction

|              |                     |
|--------------|---------------------|
| Coordinates: | 7°28' E, 46°59' N   |
| Altitude:    | 552 a.s.l.          |
| Time:        | UTC / GMT           |
| Source:      | Meteo Schweiz       |

: Table 1: Metadata for the MeteoSchweiz station in Zollikofen (reference
station)

|              |                                          |
|--------------|------------------------------------------|
| Coordinates: | 7° 27' 45,252'' E ; 46.° 57' 47,196'' N  |
| Altitude:    | 554.5 a.s.l.                             |
| Time:        | UTC-2 / GMT-2                            |
| Source:      | AFU (Amt für Umwelt der Stadt Bern)      |

: Table 2: Metadata for AFU (reference station)

+----------------+-----------------------------------------+
| Altitude:      | 7° 27' 50,65'' E ; 46.° 59' 26,844'' N  |
+----------------+-----------------------------------------+
| Altitude:      | 552.9 a.s.l.                            |
+----------------+-----------------------------------------+
| Time format:   | Old logger: UTC-2 / GMT-2               |
|                |                                         |
|                | New Logger: UTC / GMT                   |
+----------------+-----------------------------------------+
| Logger Number: | 98                                      |
+----------------+-----------------------------------------+
| Code grafana   | 20d1b9040ad9                            |
+----------------+-----------------------------------------+

: Table 3: Metadata for the 2m Logger in Zollikofen

+----------------+------------------------------------------+
| Altitude:      | 7° 27' 45,252'' E ; 46.° 57' 47,196'' N  |
+----------------+------------------------------------------+
| Altitude:      | 554.5 a.s.l.                             |
+----------------+------------------------------------------+
| Time format:   | Old logger: UTC-2 / GMT-2                |
|                |                                          |
|                | New Logger: UTC / GMT                    |
+----------------+------------------------------------------+
| Logger Number: | 83                                       |
+----------------+------------------------------------------+
| Code grafana   | d6e2769def35                             |
+----------------+------------------------------------------+

: Table 4: Metadata for the 2m Logger at AFU

# Preparation

```{r read_the_packages, warning=FALSE, error=FALSE, message=FALSE}
# install and activate all packages we need
source("../R/general/packages.R")

# We set preferences
conflicts_prefer(ggplot2::annotate)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::mutate)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::rename)
```

```{r read_the_data, warning=FALSE, error=FALSE, message=FALSE}
# We read the reference data from Zollikofen
ZOLL <- read.csv2("../data/data_REF_ZOLL.original.csv")

# We read the reference data from AFU
AFU <- read_xlsx("../data/data_REF_AFU_new.xlsx")
```

```{r file-preparation}
# We change format of time and date for reference station in Zollikofen
ZOLL$time <- strptime(ZOLL$time, format="%Y%m%d%H%M")
ZOLL$time <- as.POSIXct(ZOLL$time, tz = "ETC/GMT")
attr(ZOLL$time, "tzone")

ZOLL <- ZOLL|>
  mutate('windspeed' = as.numeric(as.character(unlist(ZOLL[,'fu3010z0']))),
         'winddirection' = as.numeric(as.character(unlist(ZOLL[,'dkl010z0']))),
         'precipitation' = as.numeric(as.character(unlist(ZOLL[,'rre150z0']))),
         'humidity' = as.numeric(as.character(unlist(ZOLL[,'ure200s0']))),
         'insolation' = as.numeric(as.character(unlist(ZOLL[,'gre000z0']))),
         'temperature' = as.numeric(as.character(unlist(ZOLL[,'tre200s0']))))|>
  select(c('time', 'temperature', 'humidity', 'insolation', 'windspeed', 'winddirection'))

# We change format of time and date for reference station in front of AFU
AFU$Zeit <- format(AFU$Zeit, format = "%H:%M")
AFU$Datum <- strptime(paste(AFU$Datum,AFU$Zeit,sep = " "), format="%Y-%m-%d %H:%M") 
AFU$Datum <- as.POSIXct(AFU$Datum, tz = "Etc/GMT-2")
attr(AFU$Datum, "tzone")

AFU <- AFU|>
  rename('time' =  Datum,
         'temperature' = Temp,
         'windspeed' = WG,
         'winddirection' = WR...5,
         'insolation' = GS,
         'pressure' = Luftdruck,
         'humidity' = Feuchte)|>
  select(c('time', 'temperature', 'humidity', 'insolation', 'windspeed', 'winddirection'))
```

# Maschine Learning (KNN-Algorithm)

## General Zollikofen

```{r calculate-AFU-models, warning=FALSE, error=FALSE, message=FALSE}
# We load our functions
source("../R/ml_functions.approach/knn.evaluation.approach.R")
source("../R/ml_functions.approach/lm.and.knn.model.approach.R")
source("../R/ml_functions.approach/knn_cv_optimizer.approach.R")
source("../R/ml_functions.approach/knn.cv.model.creater.approach.R")

set.seed(123)  

# Split 70 % to 30 % 
split_zoll_approach <- rsample::initial_split(ZOLL, prop = 0.7)
# We create a training set and a test set
ZOLL_train_approach <- rsample::training(split_zoll_approach)
ZOLL_test_approach <- rsample::testing(split_zoll_approach)

# We optimaze the hyperparameter k --> k=170
my.sequence <-c(1,2,3,4,5, seq(10, to = 50, by = 5))
parameter.extracter.knn.cv.a(my.sequence, ZOLL_train_approach, ZOLL_test_approach , 10)


# We calculate a KNN model
model.ZOLL.opt.appraoch <- knn.cv.model.a(ZOLL_train_approach, 2)

# We calculate a lm-model (to comapre with)
model.ZOLL.lm.approach <- lm.model.a(ZOLL_train_approach)
```

## General AFU

```{r calculate-AFU-model, warning=FALSE, error=FALSE, message=FALSE}
set.seed(123)  

# Split 70 % to 30 % 
split_AFU_approach <- rsample::initial_split(AFU, prop = 0.7)
# We create a training set and a test set
AFU_train_approach <- rsample::training(split_AFU_approach)
AFU_test_approach <- rsample::testing(split_AFU_approach)

# We optimaze the hyperparameter k --> k=170
my.sequence <-c(1,2,3,4,5, seq(10, to = 50, by = 5))
parameter.extracter.knn.cv.a(my.sequence, AFU_train_approach, AFU_test_approach , 10)


# We calculate a KNN model
model.AFU.opt.approach <- knn.cv.model.a(AFU_train_approach, 5)

# We calculate a lm-model (to comapre with)
model.AFU.lm.approach <- lm.model.a(AFU_train_approach)
```

## Zollikofen

```{r knn-model-zollikofen, warning=FALSE, error=FALSE, message=FALSE}
# We load our functions
source("../R/ml_functions/knn.evaluation.R")
source("../R/ml_functions/lm.and.knn.model.R")
source("../R/ml_functions/knn_cv_optimizer.R")
source("../R/ml_functions/knn.cv.model.creater.R")

# For reproducibility (pseudo-random)
set.seed(123)  

# Split 70 % to 30 % 
split_zoll <- rsample::initial_split(ZOLL, prop = 0.7)
# We create a training set and a test set
ZOLL_train <- rsample::training(split_zoll)
ZOLL_test <- rsample::testing(split_zoll)

# We optimaze the hyperparameter k --> k=170
my.sequence <-c(1,2,3,4,5, seq(100, to = 200, by = 10))
parameter.extracter.knn.cv(my.sequence, ZOLL_train, ZOLL_test , 10)


# We calculate a KNN model
model.ZOLL.opt <- knn.cv.model(ZOLL_train, 170)

# We calculate a lm-model (to comapre with)
model.ZOLL.lm <- lm.model(ZOLL_train)
```

## AFU

We do it the same for AFU...

```{r warning=FALSE, error=FALSE, message=FALSE }
# For reproducibility (pseudo-random)
set.seed(123)  
# Split 70 % to 30 % 
split_AFU <- rsample::initial_split(AFU, prop = 0.7)
# We create a training set and a test set
AFU_train <- rsample::training(split_AFU)
AFU_test <- rsample::testing(split_AFU)


my.sequence <-  c(1:25)
# We optimaze the hyperparameter k --> k = 17
parameter.extracter.knn.cv(my.sequence, AFU_train, AFU_test , 10)

# We calculate a KNN model
model.AFU.opt <- knn.cv.model(AFU_train, 17)

# We calculate a lm-model (to comapre with)
model.AFU.lm <- lm.model(AFU_train)
```

# Evaluation, spatial up-scaling and estimate performance 

## Evaluation of AFU

First, we evaluate AFU. We use our simple model (model.AFU.opt) which
contains only the target (temperature) and a predictor (humidity). We
compare our knn-model with the lm-model. We easily see that the knn
performce better than lm-model (RSQ: 0.72 vs. 0.67, RMSE: 2.71 vs. 2.95).

If we use our expanded model (model.AFU.opt.appraoch), which contains the
target (temperature) and the predictors (humidity, insolation, windspeed
and winddirection), the performance increase massively (RSQ: 0.83 vs. 0.71,
RMSE: 2.01 vs. 2.74). We see that especially the error is thereby lowered.

Now, we know the expanded KNN model is superior to all other models. Thus,
it would be preferable to use this one. Unfortunately, the new loggers
measure only temperature and humidity. We must therefore work with the
simple model. However, we recommend to extend the measurements in order to
be able to use the extended model later.

```{r model-evaluation-AFU,warning=FALSE, error=FALSE, message=FALSE }
# simple KNN
eval_model(model.AFU.opt, AFU_train_approach, AFU_test_approach, 
           c("AFU: KNN (opt. k = 17)"), c("AFU: KNN (opt. k = 17)"))

# simple lm
eval_model(model.AFU.lm, AFU_train_approach, AFU_test_approach, 
           c("AFU: lm-model"), c("AFU: lm-model"))

# expanded KNN
eval_model(model.AFU.opt.appraoch, AFU_train_approach, AFU_test_approach, 
           c("AFU: KNN-expanded (opt. k = 17)"), 
           c("AFU: KNN-expanded (opt. k = 17)"))

# expanden lm
eval_model(model.AFU.lm.approach, AFU_train_approach, AFU_test_approach, 
           c("AFU: lm-model-expanded"), c("AFU: lm-model-expanded"))
```

## Spatial up-scaling with AFU

```{r upscaling-AFU, warning=FALSE, error=FALSE, message=FALSE}
# expanded KNN
eval_model(model.AFU.opt.appraoch, AFU_train_approach, ZOLL, 
           c("Zoll: KNN-expanded (opt. k = 17)"), 
           c("Zoll: KNN-expanded (opt. k = 17)"))

# expanden lm
eval_model(model.AFU.lm.approach, AFU_train_approach, ZOLL, 
           c("AFU: lm-model-expanded"), c("AFU: lm-model-expanded"))
```

```{r read-new-logger}
# We read data from the new logger in front of AFU (2m)
new_logger_AFU <- read.csv("../data/data_logger_new/d6e2769def35.csv")

# We change format of time and date for the new logger in front of AFU
new_logger_AFU$time <- gsub('[TZ]',' ', new_logger_AFU$time)
new_logger_AFU$time <- strptime(new_logger_AFU$time, format = "%Y-%m-%d %H:%M")
new_logger_AFU$time <- as.POSIXct(new_logger_AFU$time, tz = "Etc/GMT")
attr(new_logger_AFU$time, "tzone")
# We round the time to the next 10 minute and rename a column
new_logger_AFU <- new_logger_AFU|>
  mutate('time' = lubridate::round_date(time,"10 minutes"))|>
  rename('temperature' = decodedXpayload_temperature,
         'humidity' = decodedXpayload_humidity)

eval_model(model.AFU.opt, AFU_train_approach, new_logger_AFU, 
           c("AFU: KNN (opt. k = 17)"), c("AFU: KNN (opt. k = 17)"))

eval_model(model.AFU.lm, AFU_train_approach, new_logger_AFU, 
           c("AFU: lm-model"), c("AFU: lm-model"))
```

## Evaluation of Zollikofen

Here, we evaluate Zollikofen. We use our simple model (model.ZOLL.opt)
which contains only the target (temperature) and a predictor (humidity). We
compare our knn-model with the lm-model. We easily see that the knn
performce better than lm-model (RSQ: 0.77 vs. 0.74, RMSE: 2.54 vs. 2.7).

If we use our expanded model (model.ZOLL.opt.appraoch), which contains the
target (temperature) and the predictors (humidity, insolation, windspeed
and winddirection), the performance increase massively (RSQ: 0.86 vs. 0.78,
RMSE: 1.95 vs. 2.46). We see that especially the error is thereby lowered
massively and the RSQ increase.

Now, we know the expanded KNN model is superior to all other models. Thus,
it would be preferable to use this one. Unfortunately, the new loggers
measure only temperature and humidity. We must therefore work with the
simple model. However, we recommend to extend the measurements in order to
be able to use the extended model later.

```{r evaluation-of-zollikofen, warning=FALSE, error=FALSE, message=FALSE}
# simple KNN
eval_model(model.ZOLL.opt, ZOLL_train_approach, ZOLL_test_approach, 
           c("Zoll: KNN (opt. k = 170)"), c("Zoll: KNN (opt. k = 170)"))

# simple lm
eval_model(model.ZOLL.lm, ZOLL_train_approach, ZOLL_test_approach, 
           c("Zoll: lm-model"), c("Zoll: lm-model"))

# expanded KNN
eval_model(model.ZOLL.opt.appraoch, ZOLL_train_approach, ZOLL_test_approach, 
           c("Zoll: KNN-expanded (opt. k = 2)"), c("Zoll: KNN-expanded (opt. k = 2)"))

# expanded lm
eval_model(model.ZOLL.lm.approach, ZOLL_train_approach, ZOLL_test_approach, 
           c("Zoll: lm-model-expanded"), c("Zoll: lm-model-expanded"))
```

## Spatial upscaling with Zollikofen

```{r upsacling-zollikofen, warning=FALSE, error=FALSE, message=FALSE}


# expanded KNN
eval_model(model.ZOLL.opt.appraoch, ZOLL_train_approach, AFU, 
           c("AFU: KNN-expanded (opt. k = 17)"), 
           c("AFU: KNN-expanded (opt. k = 17)"))

# expanden lm
eval_model(model.ZOLL.lm.approach, ZOLL_train_approach, AFU, 
           c("AFU: lm-model-expanded"), c("AFU: lm-model-expanded"))



```

### Zollikofen 2m Logger

```{r read-new-logger-2m}

# We read data from the new logger in Zollikofen (2m)
new_logger_zoll_2 <- read.csv("../data/data_logger_new/20d1b9040ad9.csv") 

# We change format of time and date for the new logger in Zollikofen (2m)
new_logger_zoll_2$time <- gsub('[TZ]',' ', new_logger_zoll_2$time)
new_logger_zoll_2$time <- strptime(new_logger_zoll_2$time, format="%Y-%m-%d %H:%M")
new_logger_zoll_2$time <- as.POSIXct(new_logger_zoll_2$time, tz = "Etc/GMT")
attr(new_logger_zoll_2$time, "tzone")

new_logger_zoll_2 <- new_logger_zoll_2|>
  mutate('time' = lubridate::round_date(time,"10 minutes"))|>
  rename('temperature' = decodedXpayload_temperature,
         'humidity' = decodedXpayload_humidity)

# expanded KNN
eval_model(model.ZOLL.opt.appraoch, ZOLL_train_approach, new_logger_zoll_2, 
           c("Zoll: KNN-expanded (opt. k = 2)"), c("Zoll: KNN-expanded (opt. k = 2)"))

# expanded lm
eval_model(model.ZOLL.lm.approach, ZOLL_train_approach, new_logger_zoll_2, 
           c("Zoll: lm-model-expanded"), c("Zoll: lm-model-expanded"))
```

### Zollikofen 3m Logger

```{r read-new-logger-3m}
# We read data from the new logger in Zollikofen (3m)
new_logger_zoll_3 <- read.csv("../data/data_logger_new/135a449d34a1.csv")

# We change format of time and date for the new logger in Zollikofen (2m)
new_logger_zoll_3$time <- gsub('[TZ]',' ', new_logger_zoll_3$time)
new_logger_zoll_3$time <- strptime(new_logger_zoll_3$time, format="%Y-%m-%d %H:%M")
new_logger_zoll_3$time <- as.POSIXct(new_logger_zoll_3$time, tz = "Etc/GMT")
attr(new_logger_zoll_3$time, "tzone")

new_logger_zoll_3 <- new_logger_zoll_3|>
  mutate('time' = lubridate::round_date(time,"10 minutes"))|>
  rename('temperature' = decodedXpayload_temperature,
         'humidity' = decodedXpayload_humidity)

# expanded KNN
eval_model(model.ZOLL.opt, ZOLL_train_approach, new_logger_zoll_3, 
           c("Zoll: KNN-expanded (opt. k = 2)"), c("Zoll: KNN-expanded (opt. k = 2)"))

# expanded lm
eval_model(model.ZOLL.lm, ZOLL_train_approach, new_logger_zoll_3, 
           c("Zoll: lm-model-expanded"), c("Zoll: lm-model-expanded"))
```
