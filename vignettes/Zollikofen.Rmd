---
title: "Workflow Zollikofen"
output:
  html_document:
    toc: yes
    toc_float: yes
    number_sections: yes
  pdf_document:
    toc: yes
editor_options:
  markdown:
    wrap: 75
  pdf_document:
    extra_dependencies:
    caption: ["labelfont={bf}"]
    hyperref: ["unicode=true", "breaklinks=true"]
    lmodern: null
---

Course: Field Course Micrometeorology and Urban Climate at the University
of Bern (Institute of Geography)

Supervisor: Prof. Dr. Stefan Brönnimann

Adviser: Dr. Moritz Gubler

Adviser: Nils Tinner

[Do you have questions about the workflow? Contact the
Authors:]{.underline}

Bigler Patrick
([patrick.bigler1\@students.unibe.ch](mailto:patrick.bigler1@students.unibe.ch){.email})

Sarah Ogi (sarah.ogi\@students.unibe.ch)

Markella Bouchoriku (markella.bouchoriku\@students.unibe.ch )

Reference: "Zollikofen"

# Introduction

We use the following automatic Weather Station (AWS) at Zollikofen and the
low cost device (LCD) at 2m and 3m (in Zollikofen).

|              |                   |
|--------------|-------------------|
| Coordinates: | 7°28' E, 46°59' N |
| Altitude:    | 552 a.s.l.        |
| Time:        | UTC / GMT         |
| Source:      | Meteo Schweiz     |

: Table 1: Metadata for the MeteoSchweiz station in Zollikofen (AWS)

+-----------------+-----------------------------------------+
| Altitude:       | 7° 27' 50,65'' E ; 46.° 59' 26,844'' N  |
+-----------------+-----------------------------------------+
| Altitude:       | 552.9 a.s.l.                            |
+-----------------+-----------------------------------------+
| Time format:    | Old logger: UTC-2 / GMT-2               |
|                 |                                         |
|                 | New Logger: UTC / GMT                   |
+-----------------+-----------------------------------------+
| Logger Number:  | 98                                      |
+-----------------+-----------------------------------------+
| Code grafana    | 20d1b9040ad9                            |
+-----------------+-----------------------------------------+

: Table 2: Metadata for the 2m LCD in Zollikofen

+----------------+----------------------------------------+
| Coordinates:   | 7° 27' 50,65'' E ; 46.° 59' 26,844'' N |
+----------------+----------------------------------------+
| Altitude:      | 552.9 a.s.l                            |
+----------------+----------------------------------------+
| Time format:   | Old logger: UTC-2 / GMT-2              |
|                |                                        |
|                | New Logger: UTC / GMT                  |
+----------------+----------------------------------------+
| Logger Number  | 99                                     |
+----------------+----------------------------------------+
| Code grafana   | 135a449d34a1                           |
+----------------+----------------------------------------+

: Table 3: Metadata for the 3m LCD in Zollikofen

# Preparation

First, we install and / or load packages we need. Important is the package
"conflicted". It enables us to chose if different functions have the same
call but do not make the same thing (a function in a certain package can
have the same name as a function from another package).

```{r read_the_packages, warning=FALSE, error=FALSE, message=FALSE}
# install and activate all packages we need
source("../R/general/packages.R")

# We set preferences
conflicts_prefer(ggplot2::annotate)
conflicts_prefer(dplyr::select)
conflicts_prefer(dplyr::mutate)
conflicts_prefer(dplyr::filter)
conflicts_prefer(dplyr::rename)
conflicts_prefer(Metrics::rmse)
conflicts_prefer(Metrics::mae)
conflicts_prefer(lubridate::stamp)
conflicts_prefer(lubridate::hour)
conflicts_prefer(recipes::fixed)
```

We read all the data we need:

```{r read_the_files, warning=FALSE, error=FALSE, message=FALSE}
# We read the reference data from Zollikofen (WMO Standard)
zoll_ref <- read.csv2("../data/data_REF_ZOLL.original.csv")

# We read a file with data from the old loggers
old_logger <- read_xlsx("../data/data_logger_old.xlsx")

# We read data from the new logger in Zollikofen (2m)
new_logger_zoll_2 <- read.csv("../data/data_logger_new/20d1b9040ad9.csv") 
  
# We read data from the new logger in Zollikofen (3m)
new_logger_zoll_3 <- read.csv("../data/data_logger_new/135a449d34a1.csv")
```

# Data quality

Now we need a first impression about the data. Are there any missing values
and if yes, where are they? Does it matter?

## Missing Values

We use a function which shows as how many NAs contain a certain column. We
do that for all three data sets.

```{r visualize-missing-values, warning=FALSE, error=FALSE, message=FALSE}
# Load the function to handle NAs
source("../R/general/function.visualize.na.values.R")

# We check the dataquality of the reference station
visualize.na.values.without.groups(zoll_ref)

# We check the dataquality of the reference station
visualize.na.values.without.groups(new_logger_zoll_2)

# We check the dataquality of the new loggers
visualize.na.values.without.groups(new_logger_zoll_3 )

# We check the dataquality of the old loggers
visualize.na.values.without.groups(old_logger)
```

## Time-shift

Because not all data has the same source we have to make sure all data
works in the same time zone. For that we use the package "lubridate" which
gives all the data a proper time and date stamp. The old LCD works with
CEST (Central Europe Summer Time). We define this time zone with CEST = GMT
-2. We do the same for the AWS due to the same reasons as for the old LCD
(AWS works on CEST as well). The new LCD works on UTC and therefore, we
define it as GMT. If we defined time zones, R will do the corrections
automatically (And it does not matter if we call that UTC or CEST).

Further, it is easier to work with one data frame. That is why we join all
three data frames into one. We make sure that we only use data if the date
and time occur in all three data frames. For that, we round the time to the
next 10 minutes. After that, we use inner_join and control the merge with
the time column.

At least, we change every -999 to NA.

```{r time-shift, warning=FALSE, error=FALSE, message=FALSE}
#First, change format of time and date for the old logger in front of AFU
old_logger$Sommerzeit <- strptime(old_logger$Sommerzeit, format="%Y-%m-%d %H:%M")
old_logger$Sommerzeit <- as.POSIXct(old_logger$Sommerzeit, tz = "Etc/GMT-2")
attr(old_logger$Sommerzeit, "tzone")
# We change a name of the column
old_logger <- old_logger|>
  rename('time' = Sommerzeit)

# for zollikofen 2 meter old logger
old_logger2 <- old_logger|>
  select("time","Log_98")|>
  # We change the names of the columns
  rename('temp_old_logger_2' = 'Log_98')|>
  mutate(time = lubridate::round_date(time,"10 minutes"))|>
  select(c('time', 'temp_old_logger_2'))

# for zollikofen 3 meter old logger
old_logger3 <- old_logger|>
  select("time","Log_99")|>
  # We change the names of the columns
  rename('temp_old_logger_3' = 'Log_99')|>
  mutate(time = lubridate::round_date(time,"10 minutes"))|>
  select(c('time', 'temp_old_logger_3'))

# We change format of time and date for the new logger in Zollikofen (2m)
new_logger_zoll_2$time <- gsub('[TZ]',' ', new_logger_zoll_2$time)
new_logger_zoll_2$time <- strptime(new_logger_zoll_2$time, format="%Y-%m-%d %H:%M")
new_logger_zoll_2$time <- as.POSIXct(new_logger_zoll_2$time, tz = "Etc/GMT")
attr(new_logger_zoll_2$time, "tzone")

new_logger_zoll_2 <- new_logger_zoll_2|>
  mutate(time = lubridate::round_date(time,"10 minutes"))|>
  rename(temp_new_logger_2 = decodedXpayload_temperature)

# We change format of time and date for the new logger in Zollikofen (3m)
new_logger_zoll_3$time <- gsub('[TZ]',' ', new_logger_zoll_3$time)
new_logger_zoll_3$time <- strptime(new_logger_zoll_3$time, format="%Y-%m-%d %H:%M")
new_logger_zoll_3$time <- as.POSIXct(new_logger_zoll_3$time, tz = "Etc/GMT")
attr(new_logger_zoll_3$time, "tzone")

new_logger_zoll_3 <- new_logger_zoll_3|>
  mutate(time = lubridate::round_date(time,"10 minutes"))|>
  rename(temp_new_logger_3 = decodedXpayload_temperature)

zoll_ref$time <- strptime(zoll_ref$time, format="%Y%m%d%H%M")
zoll_ref$time <- as.POSIXct(zoll_ref$time, tz = "ETC/GMT")
attr(zoll_ref$time, "tzone")

zoll_ref <- zoll_ref|>
  mutate('temp_ref' = as.numeric(tre200s0))

# we merge two data frames. Now there are only values which has the same date
zoll_all <- inner_join(new_logger_zoll_2, new_logger_zoll_3, by = 'time')

# do it again and we merge two data frames. Now there are only values which has the same date
zoll_all_2 <- inner_join(old_logger2, old_logger3, by = 'time')

zoll_all_3 <- inner_join(zoll_all, zoll_all_2, by = 'time')

zoll_combined <- inner_join(zoll_all_3, zoll_ref, by = 'time')

zoll_combined <- zoll_combined|>
  select(c('time', 'temp_ref', 'temp_new_logger_2', 'temp_new_logger_3',
           'temp_old_logger_2', 'temp_old_logger_3'))|>
  mutate(Row = c(1:3325))

# make sure that every error is equal to NA
zoll_combined[zoll_combined == -9999] <- NA
```

### Visualization of the time-shift

Because we want to be sure that the time shift worked we visualize 48h of
each data file. We see, that everything is OK and we can start with our
analysis.

```{r vis_time_shift_control, warning=FALSE, error=FALSE, message=FALSE}
# We plot 48h to be sure that the time shift worked
zoll_combined|>
  # We filter 48h
  filter(Row > 81 & Row < 375)|>
  # We create a new table
    pivot_longer(cols = c(temp_ref, temp_new_logger_2, temp_new_logger_3,
                          temp_old_logger_2, temp_old_logger_3),
               names_to = "Legend",
               values_to = "values")|>
  # We create a ggplot - line plot
  ggplot(aes(x = time, y = values, color = Legend)) + 
  geom_line(linewidth = 0.3)+
  labs(x = 'Time', y = 'Absolute Temperature [°C]', title = 'Zollikofen: Time shift control')+
  scale_color_discrete(name = "Legend", labels = c("New Logger (2m)", "New Logger (3m)", "Old Logger (2m)", "Old Logger (3m)", "Reference Station (2m)")) +
  theme_light()+
  theme(panel.border = 
          element_rect(colour = "black", fill = NA, linewidth = 1))
```

## Calculate anomalies

We are not interested in the absolute values but in the anomalies. Here, we
calculate those and add it to our data frame.

```{r warning=FALSE, error=FALSE, message=FALSE}
zoll_combined <- zoll_combined|>
  mutate('Anomaly_new_log_ref2' = temp_new_logger_2 - temp_ref,
         'Anomaly_old_log_ref2' = temp_old_logger_2 - temp_ref,
         'Anomaly_new_log_ref3' = temp_new_logger_3 - temp_ref,
         'Anomaly_old_log_ref3' = temp_old_logger_3 - temp_ref,
         'Anomaly_new_log_old_log2' = temp_new_logger_2 - temp_old_logger_2,
         'Anomaly_new_log_old_log3' = temp_new_logger_3 - temp_old_logger_3)
```

## Suspected data

We want a "feeling" for our data. Are there outliers? If yes, why there? To
answer those questions we aggregate the 10 minute resolution to a 2 hour
resolution and plot them. We can see that most of the anomalies are in a
[-3, 3] °C range.

We also see that we don't have many data. The gap between day 18 and 24
indicates that we don't have a complete month. Further, the data
variability /scattering is relatively high. We filter our data to determine
those "outliers" because it does not seems like a expected variability. Now
we know, the variability is in the night. Because we cannot explain it, we
work with the entire dataset.

```{r suspected_data, warning=FALSE, error=FALSE, message=FALSE}
# We create a column-plot of the anomalies. 
zoll_combined|>
  mutate(aggregate_hourly = lubridate::round_date(time, "2 hours"))|>
  group_by(aggregate_hourly)|>
  mutate(daily = lubridate::day(time))|>
  # We create a new table
  pivot_longer(cols = c(`Anomaly_new_log_ref2`, 
                        `Anomaly_old_log_ref2`, 
                        `Anomaly_new_log_old_log2`,
                        `Anomaly_new_log_ref3`, 
                        `Anomaly_old_log_ref3`, 
                        `Anomaly_new_log_old_log3`),
                         names_to = "Legend",
                         values_to = "values")|>
  ggplot(aes(x = daily, y = values, color = Legend))+
  geom_col(position="dodge", stat="identity")+
    guides(size = FALSE) + 
  theme(plot.margin = margin(2,.8,2,.8, "cm"),
        plot.background = element_rect(fill = "darkgrey"))+
  theme_light()

# We filter the data for all values > 3 °C --> check the rows!
zoll_combined|>
  filter(`Anomaly_new_log_ref2` > 3 | 
           `Anomaly_old_log_ref2` > 3 | 
           `Anomaly_new_log_old_log2` > 3 |
           `Anomaly_new_log_ref3` > 3 | 
           `Anomaly_old_log_ref3` > 3 | 
           `Anomaly_new_log_old_log3` > 3 )

# We write it into a CSV file
# We want to know, if a certain file already exists
name.of.file <- "../data/zoll_combined.csv"

# If do not exists such a file, create it!
if (!file.exists(name.of.file)){
  # Convert the xlsx to a csv file
  write_csv(zoll_combined, "../data/zoll_combined.csv")

  # If exists such a file, we do nothing!
  }else{}
```

# Analysis

Now we are ready for the analysis. First, we write some dynamic functions
for the plots. After that, we use box-plot, density-plots and line-graphs
to visualize the performance of the loggers. After that, we calculate the
main statistic parameters and the errors. Because the problems are probably
higher due to solar radiation through the day, we differentiate between 24h
(entire day), 6-22 (day-time) and 22-6 (night-time).

## Data Split

We split our data in daytime and night-time

```{r split_data }
zoll_day <- zoll_combined|>
  mutate(aggregate_hourly = lubridate::round_date(time, "60 minutes"))|>
  group_by(aggregate_hourly)|>
  mutate(hourly = lubridate::hour(aggregate_hourly))|>
  filter(hourly >= 6 & hourly <= 22)

zoll_night <- zoll_combined|>
  mutate(aggregate_hourly = lubridate::round_date(time, "60 minutes"))|>
  group_by(aggregate_hourly)|>
  mutate(hourly = lubridate::hour(aggregate_hourly))|>
  filter(hourly < 7 | hourly > 21)
```

## Functions

Here, we create function for the plots (line-plot, box-plot and
density-plot. We add ± standard deviation and a dot-dashed zero line
because we want to determine whether the data is accurate or and precise.
We use one function to create two different plots. All labs, title and
subtitle are dynamically.

You need a data set ,

Default --\> Line plot

Set whole = FALSE --\> scatter plot

The second function is very dynamic:

1.  Chose boxplot or density plot:
    1.  Default: you get 24 hours
    2.  set whole = False --\> you get day-time
    3.  set whole & day = false --\> you get night time

Here, you finde the function for the Line- and scatter plot

```{r load-functions}
# We load our functions into the file
source("../R/general/plot.functions.R")
```

## Line-plot

Whole Day

```{r line-plots}
# Line-plot new logger - reference station at Zollikofen 2m
overview_creater(zoll_combined, Anomaly_new_log_ref2, colnbr = 8)

# Line-plot old logger - reference station at Zollikofen 2m
overview_creater(zoll_combined, Anomaly_old_log_ref2, colnbr = 9)

# line-plot new logger - old logger at Zollikofen 2m
overview_creater(zoll_combined, Anomaly_new_log_old_log2, colnbr = 12)

# Line-plot new logger - reference station at Zollikofen 3m
overview_creater(zoll_combined, Anomaly_new_log_ref3, colnbr = 10)

# Line-plot old logger - reference station at Zollikofen 3m
overview_creater(zoll_combined, Anomaly_old_log_ref3, colnbr = 11)

# line-plot new logger - old logger at Zollikofen 3m
overview_creater(zoll_combined, Anomaly_new_log_old_log3, colnbr = 13)
```

## Boxplot

### Boxplot 24h

Whole day (default)

```{r}

pdf('../analysis/old.ref.zoll.pdf')
# Boxplot old logger - reference station at Zollikofen (2m)
boxplot_creater(zoll_combined, Anomaly_old_log_ref2, colnbr = 9, 
                title = c('old logger (2m) vs. ref station (Zoll)'),
                ylab = c('Temperature Anomaly [K]'), xlab = c('Hour of the Day [h]'))
dev.off()

pdf('../analysis/new.ref.zoll.pdf')
# Boxplot new logger - new logger at Zollikofen (2m)
boxplot_creater(zoll_combined, Anomaly_new_log_ref2, colnbr = 8,
                title = c('new logger (2m) vs. ref station (Zoll)'),
                ylab = c('Temperature Anomaly [K]'), xlab = c('Hour of the Day [h]'))
dev.off()

pdf('../analysis/old.new.zoll.pdf')
# Boxplot new logger - old logger at Zollikofen (2m)
boxplot_creater(zoll_combined, Anomaly_new_log_old_log2, colnbr = 12,
                title = c('new logger vs. old logger (Zoll)'),
                ylab = c('Temperature Anomaly [K]'), xlab = c('Hour of the Day [h]'))
dev.off()




# Boxplot new logger - reference station at Zollikofen (3m)
box_3m_24h <- boxplot_creater(zoll_combined, Anomaly_new_log_ref3, colnbr = 10,
                ylab = c('Temperature Anomaly [K]'), xlab = c('Hour of the Day [h]'))

# Boxplot old logger - reference station at Zollikofen (3m)
boxplot_creater(zoll_combined, Anomaly_old_log_ref3, colnbr = 11,
                ylab = c('Temperature Anomaly [K]'), xlab = c('Hour of the Day [h]'))

# Boxplot new logger - old logger at Zollikofen (3m)
boxplot_creater(zoll_combined, Anomaly_new_log_old_log3, colnbr = 13,
                ylab = c('Temperature Anomaly [K]'), xlab = c('Hour of the Day [h]'))

```

```{r}

# Boxplot new logger - reference station at Zollikofen (2m)
box_2m_24h <- boxplot_creater(zoll_combined, Anomaly_old_log_ref2, colnbr = 9, 
                title = c('old logger (2m) vs. ref station (Zoll)'),
                ylab = c('Temperature Anomaly [K]'), xlab = c('Hour of the Day [h]'))

pdf(file = '../analysis/graphs_report/Boxplot/boxplot_24_2_zoll.pdf',
        width = 12 / 2.54, height = 10 / 2.54)
box_2m_24h
dev.off

pdf(file = '../analysis/graphs_report/Boxplot/boxplot_24_3_zoll.pdf',
        width = 12 / 2.54, height = 10 / 2.54)
box_3m_24h
dev.off
```

### Boxplot during day-time

Day-time (set whole = FALSE)

```{r}
# Boxplot new logger - reference station at Zollikofen 2m (daytime)
box_2m_day <- boxplot_creater(zoll_combined, Anomaly_new_log_ref2, 
                              colnbr = 8, whole = FALSE,
                              ylab = c('Temperature anomaly [K]'), 
                              xlab = c('Hour of the Day [hourly mean]'))

boxplot_creater(zoll_combined, Anomaly_new_log_ref2, 
                              colnbr = 8, whole = FALSE,
                              ylab = c('Temperature anomaly [K]'), 
                              xlab = c('Hour of the Day [hourly mean]'))
# Boxplot old logger - reference station at Zollikofen 2m (daytime)
boxplot_creater(zoll_combined, Anomaly_old_log_ref2, colnbr = 9, whole = FALSE)

pdf(file = '../analysis/graphs_report/Boxplot/boxplot_day_2_zoll.pdf',
        width = 12 / 2.54, height = 10 / 2.54)
box_2m_day
dev.off



# Boxplot new logger - old logger at Zollikofen 2m (daytime)
boxplot_creater(zoll_combined, Anomaly_new_log_old_log2, colnbr = 12, whole = FALSE)

# Boxplot new logger - reference station at Zollikofen 3m (daytime)
box_3m_day <- boxplot_creater(zoll_combined, Anomaly_new_log_ref3, 
                              colnbr = 10, whole = FALSE,
                              ylab = c('Temperature anomaly [K]'), 
                              xlab = c('Hour of the Day [hourly mean]'))

pdf(file = '../analysis/graphs_report/Boxplot/boxplot_day_3_zoll.pdf',
        width = 12 / 2.54, height = 10 / 2.54)
box_3m_day
dev.off

# Boxplot old logger - reference station at Zollikofen 3m (daytime)
boxplot_creater(zoll_combined, Anomaly_old_log_ref3, colnbr = 11, whole = FALSE)

# Boxplot new logger - old logger at Zollikofen 3m (daytime)
boxplot_creater(zoll_combined, Anomaly_new_log_old_log3, colnbr = 13, whole = FALSE)
```

### Boxplot during night-time

Night-time (set whole = FALSE & day = FALSE)

```{r}
# Boxplot new logger - reference station at Zollikofen 2m (nighttime)
boxplot_creater(zoll_combined, Anomaly_new_log_ref2, colnbr = 8, 
                whole = FALSE, day = FALSE)

# Boxplot old logger - reference station at Zollikofen 2m (nighttime)
boxplot_creater(zoll_combined, Anomaly_old_log_ref2, colnbr = 9, 
                whole = FALSE, day = FALSE)

# Boxplot new logger - old logger at Zollikofen 2m (nighttime)
boxplot_creater(zoll_combined, Anomaly_new_log_old_log2, colnbr = 12, 
                whole = FALSE, day = FALSE)

# Boxplot new logger - reference station at Zollikofen 3m (nighttime)
boxplot_creater(zoll_combined, Anomaly_new_log_ref3, colnbr = 10, 
                whole = FALSE, day = FALSE)

# Boxplot old logger - reference station at Zollikofen 3m (nighttime)
boxplot_creater(zoll_combined, Anomaly_old_log_ref3, colnbr = 11, 
                whole = FALSE, day = FALSE)

# Boxplot new logger - old logger at Zollikofen 3m (nighttime)
boxplot_creater(zoll_combined, Anomaly_new_log_old_log3, colnbr = 13, 
                whole = FALSE, day = FALSE)
```

## Density-plot

### Density-Plot 24h

Whole day (default)

```{r}
# Densityplot new logger - reference station at Zollikofen (2m)
densityplot_creater(zoll_combined, Anomaly_new_log_ref2, colnbr = 8)

# Densityplot old logger - reference station at Zollikofen (2m)
densityplot_creater(zoll_combined, Anomaly_old_log_ref2, colnbr = 9)

# Densityplot new logger - old logger at Zollikofen (2m)
densityplot_creater(zoll_combined, Anomaly_new_log_old_log2, colnbr = 12)

# Densityplot new logger - reference station at Zollikofen (3m)
densityplot_creater(zoll_combined, Anomaly_new_log_ref3, colnbr = 10)

# Densityplot old logger - reference station at Zollikofen (3m)
densityplot_creater(zoll_combined, Anomaly_old_log_ref3, colnbr = 11)

# Densityplot new logger - old logger at Zollikofen (3m)
densityplot_creater(zoll_combined, Anomaly_new_log_old_log3, colnbr = 13)
```

### Density-Plot during day-time

Day-time (set whole = FALSE)

```{r}
# Densityplot new logger - reference station at Zollikofen 2m (daytime)
density_2m_day <- densityplot_creater(zoll_combined, Anomaly_new_log_ref2, 
                    colnbr = 8, whole = FALSE,
                    ylab = c('Density'), 
                    xlab = c('Measured temperature anomalies [K]'))

pdf(file = '../analysis/graphs_report/Densityplot//density_day_2_zoll.pdf',
        width = 12 / 2.54, height = 10 / 2.54)
density_2m_day
dev.off

# Densityplot old logger - reference station at Zollikofen 2m (daytime)
densityplot_creater(zoll_combined, Anomaly_old_log_ref2, colnbr = 9, whole = FALSE)

# Densityplot new logger - old logger at Zollikofen 2m (daytime)
densityplot_creater(zoll_combined, Anomaly_new_log_old_log2, colnbr = 12, whole = FALSE)

# Densityplot new logger - reference station at Zollikofen 3m (daytime)
density_3m_day <- densityplot_creater(zoll_combined, Anomaly_new_log_ref3, 
                    colnbr = 10, whole = FALSE,
                    ylab = c('Density'), 
                    xlab = c('Measured temperature anomalies [K]'))

pdf(file = '../analysis/graphs_report/Densityplot//density_day_3_zoll.pdf',
        width = 12 / 2.54, height = 10 / 2.54)
density_3m_day
dev.off

# Densityplot old logger - reference station at Zollikofen 3m (daytime)
densityplot_creater(zoll_combined, Anomaly_old_log_ref3, colnbr = 11, whole = FALSE)

# Densityplot new logger - old logger at Zollikofen 3m (daytime)
densityplot_creater(zoll_combined, Anomaly_new_log_old_log3, colnbr = 13, whole = FALSE)

```

### Density-Plot during night-time

Night-time (set whole = FALSE & day = FALSE)

```{r}
# Densityplot new logger - reference station at Zollikofen 2m (nighttime)
densityplot_creater(zoll_combined, Anomaly_new_log_ref2, colnbr = 8, 
                    whole = FALSE, day = FALSE)

# Densityplot old logger - reference station at Zollikofen 2m (nighttime)
densityplot_creater(zoll_combined, Anomaly_old_log_ref2, colnbr = 9, 
                    whole = FALSE, day = FALSE)

# Densityplot new logger - old logger at Zollikofen 2m (nighttime)
densityplot_creater(zoll_combined, Anomaly_new_log_old_log2, colnbr = 12, 
                    whole = FALSE, day = FALSE)

# Densityplot new logger - reference station at Zollikofen 3m (nighttime)
densityplot_creater(zoll_combined, Anomaly_new_log_ref3, colnbr = 10, 
                    whole = FALSE, day = FALSE)

# Densityplot old logger - reference station at Zollikofen 3m (nighttime)
densityplot_creater(zoll_combined, Anomaly_old_log_ref3, colnbr = 11, 
                    whole = FALSE, day = FALSE)

# Densityplot new logger - old logger at Zollikofen 3m (nighttime)
densityplot_creater(zoll_combined, Anomaly_new_log_old_log3, colnbr = 13, 
                    whole = FALSE, day = FALSE)

```

# Statistics

## Errors

It is very complicate to calculate because the RMSE and MAE from the
Metrics packages do not accept NAs. So we have to write a function
manually...

```{r}
VARIABLE <- c('24h, new_2 - ref', '24h, old_2 - ref',
           '24h, new_3 - ref', '24h, old_3 - ref',
           'day-time, new_2 - ref', 'day-time, old_2 - ref', 
           'day-time, new_3 - ref', 'day-time, old_3 - ref',
           'night-time, new_2 - ref', 'night-time, old_2 - ref',
           'night-time, new_3 - ref', 'night-time, old_3 - ref',
           '24h, new_2 - old_2', '24h, new_3 - old_3',
           'day-time, new_2 - old_2', 'day-time, new_3 - old_3',
           'night-time, new_2 - old_2', 'night-time, new_3 - old_3')
###############################################################################################
RMSE <- c(round(sqrt(mean((zoll_combined$temp_new_logger_2-zoll_combined$temp_ref)^2, 
                          na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_combined$temp_old_logger_2-zoll_combined$temp_ref)^2, 
                          na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_combined$temp_new_logger_3-zoll_combined$temp_ref)^2, 
                          na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_combined$temp_old_logger_3-zoll_combined$temp_ref)^2, 
                          na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_day$temp_new_logger_2-zoll_day$temp_ref)^2, na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_day$temp_old_logger_2-zoll_day$temp_ref)^2, na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_day$temp_new_logger_3-zoll_day$temp_ref)^2, na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_day$temp_old_logger_3-zoll_day$temp_ref)^2, na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_night$temp_new_logger_2-zoll_night$temp_ref)^2, na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_night$temp_old_logger_2-zoll_night$temp_ref)^2, na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_night$temp_new_logger_3-zoll_night$temp_ref)^2, na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_night$temp_old_logger_3-zoll_night$temp_ref)^2, na.rm = TRUE)), 
                digits = 3),
          round(sqrt(mean((zoll_combined$temp_old_logger_2-zoll_combined$temp_new_logger_2)^2,
                          na.rm = TRUE)), digits = 3),
          round(sqrt(mean((zoll_combined$temp_old_logger_3-zoll_combined$temp_new_logger_3)^2,
                          na.rm = TRUE)), digits = 3),
          round(sqrt(mean((zoll_day$temp_old_logger_2-zoll_day$temp_new_logger_2)^2, 
                          na.rm = TRUE)), digits = 3),
          round(sqrt(mean((zoll_day$temp_new_logger_3-zoll_day$temp_old_logger_3)^2,
                          na.rm = TRUE)), digits = 3),
          round(sqrt(mean((zoll_night$temp_old_logger_2-zoll_night$temp_new_logger_2)^2, 
                          na.rm = TRUE)), digits = 3),
          round(sqrt(mean((zoll_night$temp_new_logger_3-zoll_night$temp_old_logger_3)^2,
                          na.rm = TRUE)), digits = 3))
###############################################################################################
MAE <- c(round(mean(abs(zoll_combined$temp_new_logger_2-zoll_combined$temp_ref),
                    na.rm = TRUE), digits = 3),
          round(mean(abs(zoll_combined$temp_old_logger_2-zoll_combined$temp_ref), 
                     na.rm = TRUE), digits = 3),
          round(mean(abs(zoll_combined$temp_new_logger_3-zoll_combined$temp_ref), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_combined$temp_old_logger_3-zoll_combined$temp_ref), 
                     na.rm = TRUE), digits = 3),
          round(mean(abs(zoll_day$temp_new_logger_2-zoll_day$temp_ref), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_day$temp_old_logger_2-zoll_day$temp_ref), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_day$temp_new_logger_3-zoll_day$temp_ref), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_day$temp_old_logger_3-zoll_day$temp_ref), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_night$temp_new_logger_2-zoll_night$temp_ref), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_night$temp_old_logger_2-zoll_night$temp_ref), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_night$temp_new_logger_3-zoll_night$temp_ref), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_night$temp_old_logger_3-zoll_night$temp_ref), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_combined$temp_old_logger_2-zoll_combined$temp_new_logger_2),
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_combined$temp_old_logger_3-zoll_combined$temp_new_logger_3),
                          na.rm = TRUE), digits = 3),
          round(mean(abs(zoll_day$temp_old_logger_2-zoll_day$temp_new_logger_2), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_day$temp_new_logger_3-zoll_day$temp_old_logger_3), 
                     na.rm = TRUE),digits = 3),
          round(mean(abs(zoll_night$temp_old_logger_2-zoll_night$temp_new_logger_2), 
                     na.rm = TRUE), digits = 3),
          round(mean(abs(zoll_night$temp_new_logger_3-zoll_night$temp_old_logger_3), 
                     na.rm = TRUE),digits = 3))
###############################################################################################
BIAS <- c(round((sum(zoll_combined$temp_new_logger_2 - zoll_combined$temp_ref, na.rm = TRUE)/
                   length(zoll_combined$temp_ref)), digits = 3), 
          round((sum(zoll_combined$temp_old_logger_2 - zoll_combined$temp_ref, na.rm = TRUE)/
                   length(zoll_combined$temp_ref)), digits = 3),
          round((sum(zoll_combined$temp_new_logger_3 - zoll_combined$temp_ref, na.rm = TRUE)/
                   length(zoll_combined$temp_ref)), digits = 3),
          round((sum(zoll_combined$temp_old_logger_3 - zoll_combined$temp_ref, na.rm = TRUE)/
                   length(zoll_combined$temp_ref)), digits = 3),
          round((sum(zoll_day$temp_new_logger_2 - zoll_day$temp_ref, na.rm = TRUE)/
                   length(zoll_day$temp_ref)), digits = 3), 
          round((sum(zoll_day$temp_old_logger_2 - zoll_day$temp_ref, na.rm = TRUE)/
                   length(zoll_day$temp_ref)), digits = 3),
          round((sum(zoll_day$temp_new_logger_3 - zoll_day$temp_ref, na.rm = TRUE)/
                   length(zoll_day$temp_ref)), digits = 3),
          round((sum(zoll_day$temp_old_logger_3 - zoll_day$temp_ref, na.rm = TRUE)/
                   length(zoll_day$temp_ref)), digits = 3),
          round((sum(zoll_night$temp_new_logger_2 - zoll_night$temp_ref, na.rm = TRUE)/
                   length(zoll_night$temp_ref)), digits = 3), 
          round((sum(zoll_night$temp_old_logger_2 - zoll_night$temp_ref, na.rm = TRUE)/
                   length(zoll_night$temp_ref)), digits = 3),
          round((sum(zoll_night$temp_new_logger_3 - zoll_night$temp_ref, na.rm = TRUE)/
                   length(zoll_night$temp_ref)), digits = 3),
          round((sum(zoll_night$temp_old_logger_3 - zoll_night$temp_ref, na.rm = TRUE)/
                   length(zoll_night$temp_ref)), digits = 3),
          round((sum(zoll_combined$temp_new_logger_2 - zoll_combined$temp_old_logger_2,
                     na.rm = TRUE)/
                   length(zoll_combined$temp_old_logger_2)), digits = 3),
          round((sum(zoll_combined$temp_new_logger_3 - zoll_combined$temp_old_logger_3, 
                     na.rm = TRUE)/
                   length(zoll_combined$temp_old_logger_3)), digits = 3),
          round((sum(zoll_day$temp_new_logger_2 - zoll_day$temp_old_logger_2, 
                     na.rm = TRUE)/
                   length(zoll_day$temp_old_logger_2)), digits = 3),
          round((sum(zoll_night$temp_new_logger_3 - zoll_night$temp_old_logger_3, 
                     na.rm = TRUE)/
                   length(zoll_night$temp_old_logger_3)), digits = 3),
                 round((sum(zoll_night$temp_new_logger_2 - zoll_night$temp_old_logger_2,
                            na.rm = TRUE)/
                   length(zoll_night$temp_old_logger_2)), digits = 3),
          round((sum(zoll_night$temp_new_logger_3 - zoll_night$temp_old_logger_3, 
                     na.rm = TRUE)/
                   length(zoll_night$temp_ref)), digits = 3))

###############################################################################################
df <- cbind(VARIABLE, RMSE, MAE, BIAS)
knitr::kable(df, caption = 'Table 1: Overview about error-metrics at Zollikofen')|>
    kableExtra::kable_classic_2(full_width = T)
###############################################################################################
# Generate Latex-code
xtable(df, align = c('l', 'c', 'c', 'c', 'c'))
```

## Main paramater

We calculate the main statistic parameter sfor the entire day (24h),
daytime and nighttime. At the end, we also create a LATEX table

```{r}
# Calculate the main statistic parameters
# for 24h
zoll_24 <- data.frame(zoll_combined|>
  rename(new_ref_2 = `Anomaly_new_log_ref2`,
         old_ref_2 = `Anomaly_old_log_ref2`,
         new_old_2 = `Anomaly_new_log_old_log2`,
         new_ref_3 = `Anomaly_new_log_ref3`,
         old_ref_3 = `Anomaly_old_log_ref3`,
         new_old_3 = `Anomaly_new_log_old_log3`)|>
  mutate(aggregate_hourly = lubridate::round_date(time, "60 minutes"))|>
  group_by(aggregate_hourly)|>
  mutate(hourly = lubridate::hour(aggregate_hourly))|>
  pivot_longer(cols = c(`new_ref_2`, `old_ref_2`, `new_old_2`,
                        `new_ref_3`, `old_ref_3`, `new_old_3`),
                         names_to = "Device",
                         values_to = "values")|>
  select('Device', 'values')|>
  group_by(Device)|>
  dplyr::summarise(mean = round(mean(values, na.rm = TRUE), digits = 3),
         median = round(median(values, na.rm = TRUE), digits = 3),
         max = round(max(values, na.rm = TRUE), digits = 3),
         min = round(min(values, na.rm = TRUE), digits = 3),
         std = round(sd(values, na.rm = TRUE), digits = 3),
         q25 = round(quantile(values, probs = .25,na.rm = TRUE), digits = 3),
         q75 = round(quantile(values, probs = .75,na.rm = TRUE), digits = 3),
         iqr = round(IQR(values,na.rm = TRUE), digits = 3),
         spread = round(max(values, na.rm = TRUE)-min(values, na.rm = TRUE), digits = 3),
         skewness = round(skewness(values, na.rm = TRUE), digits = 3)))
###############################################################################################
# During day-time
zoll_daytime <- zoll_combined|>
  rename(new_ref_2 = `Anomaly_new_log_ref2`,
         old_ref_2 = `Anomaly_old_log_ref2`,
         new_old_2 = `Anomaly_new_log_old_log2`,
         new_ref_3 = `Anomaly_new_log_ref3`,
         old_ref_3 = `Anomaly_old_log_ref3`,
         new_old_3 = `Anomaly_new_log_old_log3`)|>
  mutate(aggregate_hourly = lubridate::round_date(time, "60 minutes"))|>
  group_by(aggregate_hourly)|>
  mutate(hourly = lubridate::hour(aggregate_hourly))|>
  filter(hourly >= 6 & hourly <= 22)|>    
  pivot_longer(cols = c(`new_ref_2`, `old_ref_2`, `new_old_2`,
                        `new_ref_3`, `old_ref_3`, `new_old_3`),
                         names_to = "Device",
                         values_to = "values")|>
  select('Device', 'values')|>
  group_by(Device)|>
  dplyr::summarise(mean = round(mean(values, na.rm = TRUE), digits = 3),
         median = round(median(values, na.rm = TRUE), digits = 3),
         max = round(max(values, na.rm = TRUE), digits = 3),
         min = round(min(values, na.rm = TRUE), digits = 3),
         std = round(sd(values, na.rm = TRUE), digits = 3),
         q25 = round(quantile(values, probs = .25,na.rm = TRUE), digits = 3),
         q75 = round(quantile(values, probs = .75,na.rm = TRUE), digits = 3),
         iqr = round(IQR(values,na.rm = TRUE), digits = 3),
         spread = round(max(values, na.rm = TRUE)-min(values, na.rm = TRUE), digits = 3),
         skewness = round(skewness(values, na.rm = TRUE), digits = 3))
###############################################################################################
# during night-time
zoll_nighttime <- zoll_combined|>
  rename(new_ref_2 = `Anomaly_new_log_ref2`,
         old_ref_2 = `Anomaly_old_log_ref2`,
         new_old_2 = `Anomaly_new_log_old_log2`,
         new_ref_3 = `Anomaly_new_log_ref3`,
         old_ref_3 = `Anomaly_old_log_ref3`,
         new_old_3 = `Anomaly_new_log_old_log3`)|>
  mutate(aggregate_hourly = lubridate::round_date(time, "60 minutes"))|>
  group_by(aggregate_hourly)|>
  mutate(hourly = lubridate::hour(aggregate_hourly))|>
  filter(hourly < 7 | hourly > 21)|>    
  pivot_longer(cols = c(`new_ref_2`, `old_ref_2`, `new_old_2`,
                        `new_ref_3`, `old_ref_3`, `new_old_3`),
                         names_to = "Device",
                         values_to = "values")|>
  select('Device', 'values')|>
  group_by(Device)|>
  dplyr::summarise(mean = round(mean(values, na.rm = TRUE), digits = 3),
         median = round(median(values, na.rm = TRUE), digits = 3),
         max = round(max(values, na.rm = TRUE), digits = 3),
         min = round(min(values, na.rm = TRUE), digits = 3),
         std = round(sd(values, na.rm = TRUE), digits = 3),
         q25 = round(quantile(values, probs = .25,na.rm = TRUE), digits = 3),
         q75 = round(quantile(values, probs = .75,na.rm = TRUE), digits = 3),
         iqr = round(IQR(values,na.rm = TRUE), digits = 3),
         spread = round(max(values, na.rm = TRUE)-min(values, na.rm = TRUE), digits = 3),
         skewness = round(skewness(values, na.rm = TRUE), digits = 3))
###############################################################################################
# generate latex code
xtable(zoll_24, align = c('l', rep('c', times = 11)))
xtable(zoll_daytime, align = c('l', rep('c', times = 11)))
xtable(zoll_nighttime, align = c('l', rep('c', times = 11)))
```

# Appendix

## Windspeed

```{r}

ZOLL <- read.csv2("../data/data_REF_ZOLL.original.csv")

# We change format of time and date for reference station in Zollikofen
ZOLL$time <- strptime(ZOLL$time, format="%Y%m%d%H%M")
ZOLL$time <- as.POSIXct(ZOLL$time, tz = "ETC/GMT")
attr(ZOLL$time, "tzone")

ZOLL <- ZOLL|>
  mutate('windspeed' = as.numeric(as.character(unlist(ZOLL[,'fu3010z0']))),
         'winddirection' = as.numeric(as.character(unlist(ZOLL[,'dkl010z0']))),
         'precipitation' = as.numeric(as.character(unlist(ZOLL[,'rre150z0']))),
         'humidity' = as.numeric(as.character(unlist(ZOLL[,'ure200s0']))),
         'insolation' = as.numeric(as.character(unlist(ZOLL[,'gre000z0']))),
         'temperature' = as.numeric(as.character(unlist(ZOLL[,'tre200s0']))))|>
  select(c('time', 'temperature', 'humidity', 'insolation', 'windspeed', 'winddirection'))


pdf('../analysis/graphs_report/windspeed.zoll.pdf',
        width = 12 / 2.54, height = 10 / 2.54)
ZOLL|>
  select(c(time, windspeed))|>
  mutate(hour_of_the_day = lubridate::hour(time))|>
  ggplot(aes(x = factor(hour_of_the_day), y = windspeed))+
  geom_boxplot(fill = "skyblue", alpha = 0.5, lwd = 0.3, width = 0.5,
                   outlier.color = "red", outlier.shape = 17, outlier.size = 2)+
  geom_jitter(width = 0, alpha = 0.01)+
  stat_boxplot(geom = "errorbar", size = 0.3, width = 0.3)+
  labs(x = 'Hour of the day', y = 'Windspeed [km/h]')+
  theme_light()
dev.off()
```
